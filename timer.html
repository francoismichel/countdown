<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="svg/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <title>Boutsen Ginion countdown</title>
</head>
<body>
<!--<h1>Countdown</h1>-->

<!--<div class="container" id="timer"></div>-->
<!-- Optional JavaScript; choose one of the two! -->
<div class="container-fluid" style="width: 100%; margin-top: 50px; height: 100vh">

    <!--    <div class="text-center">-->
    <!--        <img style="text-align: center" src="images/boutsen.jpg" width="50%"     alt="">-->
    <!--    </div>-->
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div class="text-left display-1 font-weight-bold"> <strong id="current-time">00:00:00</strong> </div>
        </div>
        <div class="col-md-2">
            <img src="images/boutsen.jpg" width="200" height="100" alt="">
        </div>
    </div>


    <div id="timer-container" class="container border rounded-3">
            <div class="text-center display-1 font-weight-bold"> <strong id="event-to-expire">-</strong> </div>
            <div class="text-center display-7 font-weight-bold"> Expires in </div>
            <div class="text-center display-1 font-weight-bold" style="font-size: 6rem"> <strong id="timer">00:00:00</strong> </div>
    </div>

    <div id="summaries-container" class="container" style="margin-top: 25px">
        <div class="row">
            <div class="col-md-6">
                <div class="container-fluid border rounded-3">
                    <h3 class="text-center">Next stop around :</h3>
                    <h2 class="text-center"><span id="next-stop-time">-</span></h2>
                    <table class="table" id="next-stop-summary-table">
                        <thead>
                        <tr>
                            <th scope="col">To do</th>
                        </tr>
                        </thead>
                        <tbody id="next-stop-summary-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <div class="container-fluid border rounded-3">
                    <h3 class="text-center">Planning of the day:</h3>
                    <table class="table" id="planning-of-the-day-summary-table">
                        <thead>
                        <tr>
                            <th scope="col">Time</th>
                            <th scope="col">Event</th>
                        </tr>
                        </thead>
                        <tbody id="planning-of-the-day-summary-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tables-container" class="container" style="height: 100vh">
    <div class="row">
        <div class="col-md-6">
            <div style="margin: 10px">
                <label for="next-stop-job-flattimepicker">Select time :</label>
                <input type="text" id="next-stop-job-flattimepicker" placeholder="Select time.." class="flattimepickerinput" style="width: 50%" data-input hidden>

            </div>

            <table class="table" id="subtasks-table">
                <thead>
                <tr>
                    <th scope="col" data-name="completed" style="text-align:center"> <span style="text-align: center">Completed</span></th>
                    <th scope="col" data-name="next-stop-job">Next stop job</th>
                    <th scope="col" data-name="next-stop-job"><button class="btn btn-sm btn-success" onclick="loadSubtasks()"><i class="bi bi-check"></i></button></th>
                    <th scope="col" data-name="next-stop-job"><button class="btn btn-sm btn-danger" onclick="clearSubtasks()"><i class="bi bi-trash"></i></button></th>
                </tr>
                </thead>
                <tbody id="subtasks-table-body">
                <tr>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox"    type="checkbox"></td>
                    <td class="table-cell"> Tires change set: <input class="table-input" type="text"></td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Fuel in: <input class="table-input" type="text"> kg</td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Driver change: <input class="table-input" type="text"></td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Check pressure </td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Check tires temp </td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Check brake temp </td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Blanking <input class="table-input" type="text"></td>
                </tr>
                <tr>
                    <td style="text-align:center"> <input class="table-checkbox" type="checkbox"></td>
                    <td class="table-cell"> Setup change: <input class="table-input" type="text"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="col-md-6">

            <div style="margin: 10px">
                <!--    <input type="time" id="timepicker" name="timepicker"-->
                <!--           min="00:00:00" max="23:59:59" step="1" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" required>-->
                <label for="flattimepicker">Next stop job time :</label>
                <input type="text" id="flattimepicker" placeholder="Select time.." class="flattimepickerinput" style="width: 50%" data-input hidden>

                <input type="text" id="event-name" name="event-name" placeholder="Event name">
                <button class="btn btn-sm btn-success" onclick="addDeadline()"><i class="bi bi-check2"></i></button>
                <span style="width: 100%"><button class="float-right btn btn-sm btn-danger" onclick="resetEvents()"><i class="bi bi-trash"></i> Remove all </button></span>
                <span style="width: 100%"><button class="float-right btn btn-sm btn-warning" onclick="document.getElementById('file-selector').click();"><i class="bi bi-upload"></i> Load </button></span>
                <span style="width: 100%"><button class="float-right btn btn-sm btn-primary" onclick="saveFile()"><i class="bi bi-save"></i> Save </button></span>
                <input type="file" id="file-selector" hidden>
                <a id="save-file" href=""></a>
            </div>
            <table class="table" id="countdown-table">
                <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col" data-name="time">Time</th>
                    <th scope="col" data-name="event">Event</th>
                    <th scope="col" data-name="action">Action</th>
                </tr>
                </thead>
                <tbody id="countdown-table-body">
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Option 1: Bootstrap Bundle with Popper -->

<!-- Option 2: Separate Popper and Bootstrap JS -->
<!--
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>
-->
<script>

    function timeToDate(obj) {
        return new Date(0, 0, 0, obj.hours, obj.minutes, obj.seconds);
    }

    function dateToTime(date) {
        return {
            hours: date.getHours(),
            minutes: date.getMinutes(),
            seconds: date.getSeconds(),
        }
    }


    var countDownEvents = [
        // {
        //     hours: 22, minutes: 43, seconds: 5,
        // },
    ];

    function loadSubtasks() {

        var checkboxes = document.getElementsByClassName("table-checkbox");
        var inputs = document.getElementsByClassName("table-input");
        var cells = document.getElementsByClassName("table-cell");

        const subTasksTable = document.getElementById("subtasks-table");
        const subTasksTableBody = document.getElementById("subtasks-table-body");
        const table = document.getElementById("next-stop-summary-table");
        const tbody = document.getElementById("next-stop-summary-table-body");

        // set the absolute time of the next stop
        document.getElementById("next-stop-time").innerHTML = document.getElementById("next-stop-job-flattimepicker").value;

        var input_str = '<input class="table-input" type="text">';

        tbody.innerHTML = "";
        for (var i  = 0 ; i < cells.length ; i++) {
            if (checkboxes[i].checked) {
                var cell = cells[i];
                var cell_inputs = cell.getElementsByClassName("table-input");
                var cell_input = cell_inputs.length > 0 ? cell_inputs[0] : undefined;
                var row = tbody.insertRow();
                var cell_txt = cell.innerHTML;
                if (cell_input !== undefined) {
                    cell_txt = cell_txt.replace(input_str, cell_input.value);
                }
                row.setAttribute("data-subtask-row-idx", i);
                var todo = row.insertCell(0);
                todo.innerHTML = cell_txt;
            }
        }
        clearSubtasks();
    }

    function clearSubtasks() {

        var checkboxes = document.getElementsByClassName("table-checkbox");
        for (var i  = 0 ; i < checkboxes.length ; i++) {
            console.log(checkboxes[i]);
            checkboxes[i].checked = false;
        }
        var inputs = document.getElementsByClassName("table-input");
        for (var i  = 0 ; i < inputs.length ; i++) {
            inputs[i].value = "";
        }
    }

    function saveFile() {
        var jsonFile = JSON.stringify(countDownEvents);
        var saveFile = document.getElementById('save-file');
        saveFile.setAttribute('href',
            'data:text/plain;charset=utf-8, '
            + encodeURIComponent(jsonFile));
        saveFile.setAttribute('download', "countdown.json");
        saveFile.click();
    }


    function compareTimes(a, b) {
        var timeA = a.hours*3600 + a.minutes*60 + a.seconds;
        var timeB = b.hours*3600 + b.minutes*60 + b.seconds;
        if (timeA < timeB) {
            return -1;
        }
        if (timeA === timeB) {
            return 0;
        }
        return 1;
    }

    function timeExpired(time) {
        return compareTimes(time, dateToTime(new Date())) < 0;
    }

    // Set the date we're counting down to
    // var countDownDate = new Date("Jan 5, 2022 15:37:25").getTime();

    function updateTables(items) {
        loadTableData(items);
        loadPlanningOfTheDayData(items);
    }

    function loadTableData(items) {
        items.sort(compareTimes);
        const table = document.getElementById("countdown-table");
        const tbody = document.getElementById("countdown-table-body");
        tbody.innerHTML = "";
        items.forEach( (item, index) => {
            var row = tbody.insertRow();
            row.setAttribute("data-row-idx", index);
            var idx = row.insertCell(0);
            idx.innerHTML = index+1;
            var date = row.insertCell(1);
            // date.innerHTML = item.hours + ":" + item.minutes + ":" + item.seconds;

            if (!Number.isInteger(item.hours)) {
                item.hours = 0;
            }
            if (!Number.isInteger(item.minutes)) {
                item.minutes = 0;
            }
            if (!Number.isInteger(item.hours)) {
                item.seconds = 0;
            }

            date.innerHTML = timeString(item.hours, item.minutes, item.seconds);
            var name = row.insertCell(2);
            name.innerHTML = item.name;
            var action = row.insertCell(3);
            action.innerHTML = "<button class=\"btn btn-sm btn-danger\" onclick=\"removeDeadline("+index+")\"><i class=\"bi bi-trash\"></i></button>";
            if (timeExpired(item)) {
                date.innerHTML += " (expired)";
                row.className = "bg-light";
            }
        });
    }


    function loadPlanningOfTheDayData(items) {

        items.sort(compareTimes);
        const table = document.getElementById("planning-of-the-day-summary-table");
        const tbody = document.getElementById("planning-of-the-day-summary-table-body");
        tbody.innerHTML = "";
        items.forEach( (item, index) => {
            var row = tbody.insertRow();
            row.setAttribute("data-row-idx", index);
            var date = row.insertCell(0);
            // date.innerHTML = item.hours + ":" + item.minutes + ":" + item.seconds;

            if (!Number.isInteger(item.hours)) {
                item.hours = 0;
            }
            if (!Number.isInteger(item.minutes)) {
                item.minutes = 0;
            }
            if (!Number.isInteger(item.hours)) {
                item.seconds = 0;
            }

            date.innerHTML = timeString(item.hours, item.minutes, item.seconds);

            var event = row.insertCell(1);
            event.innerHTML = item.name;
        });
    }


    function refreshExpiredRows() {
        const table = document.getElementById("countdown-table");

        for (var i = 0; i < table.rows.length; i++) {
            //iterate through rows
            var row = table.rows[i];
            if (row.getAttribute("data-row-idx") !== undefined && row.getAttribute("data-row-idx") !== null) {
                var idx = Number(row.getAttribute("data-row-idx"));
                var item = countDownEvents[idx];
                var date = row.cells[1];
                date.innerHTML = timeString(item.hours, item.minutes, item.seconds);
                if (timeExpired(item)) {
                    date.innerHTML += " (expired)";
                    row.className = "bg-light";
                }
            }
        }
    }

    function resetEvents() {
        countDownEvents = []
        localStorage.events = JSON.stringify(countDownEvents);
        updateTables(countDownEvents);
    }

    function removeDeadline(index) {
        countDownEvents.splice(index, 1);
        updateTables(countDownEvents);
        // localStorage.setItem("events", JSON.stringify(countDownEvents));
        localStorage.events = JSON.stringify(countDownEvents);
    }


    function addDeadline() {
        var input = document.getElementById("flattimepicker");

        var splitted = input.value.split(":");

        var eventName = document.getElementById("event-name").value;
        var event = {name:eventName, hours: Number(splitted[0]), minutes: Number(splitted[1]), seconds: Number(splitted[2])};

        if (!Number.isInteger(event.hours)) {
            event.hours = 18;
        }
        if (!Number.isInteger(event.minutes)) {
            event.minutes = 0;
        }
        if (!Number.isInteger(event.hours)) {
            event.seconds = 0;
        }

        countDownEvents.push(event);
        updateTables(countDownEvents);
        // localStorage.setItem("events", JSON.stringify(countDownEvents));
        localStorage.events = JSON.stringify(countDownEvents);
    }

    function timeString(hours, minutes, seconds) {
        var hoursStr = "" + hours;
        if (hoursStr.length === 1) {
            hoursStr = "0" + hoursStr;
        }
        var minutesStr = "" + minutes;
        if (minutesStr.length === 1) {
            minutesStr = "0" + minutesStr;
        }
        var secondsStr = "" + seconds;
        if (secondsStr.length === 1) {
            secondsStr = "0" + secondsStr;
        }
        return hoursStr + ":" + minutesStr + ":" + secondsStr;
    }

    function updateCount() {
        countDownEvents.sort(compareTimes);
        var now = new Date();
        var countDownIndex = 0;


        while (countDownIndex < countDownEvents.length) {

            if (compareTimes(countDownEvents[countDownIndex], dateToTime(now)) >= 0) {
                break;
            } else {
                // expired, pop it ?
                // countDownEvents.pop();
            }
            countDownIndex++;
        }
        if (countDownIndex < countDownEvents.length) {
            var countDownDate = new Date();
            countDownDate.setHours(countDownEvents[countDownIndex].hours);
            countDownDate.setMinutes(countDownEvents[countDownIndex].minutes);
            countDownDate.setSeconds(countDownEvents[countDownIndex].seconds);
            var countDownDateNumber = countDownDate.getTime();
            // Get today's date and time

            // Find the distance between now and the count down date
            var distance = countDownDateNumber - now;

            // Time calculations for days, hours, minutes and seconds
            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result in the element with id="timer"
            document.getElementById("timer").innerHTML = timeString(hours, minutes, seconds);
            document.getElementById("event-to-expire").innerHTML = countDownEvents[countDownIndex].name;
            
            // put background in red
            // if (days === 0 && hours === 0 && minutes < 5 /*&& seconds < 30*/) {
            //     document.getElementById("timer-container").classList.add("bg-danger")
            // } else {
            //     document.getElementById("timer-container").classList.remove("bg-danger")
            // }



            // If the count down is finished, write some text
        } else if (countDownEvents.length > 0) {
            document.getElementById("timer").innerHTML = "EXPIRED";
        } else {
            document.getElementById("event-to-expire").innerHTML = "-";
            document.getElementById("timer").innerHTML = "00:00:00";
        }
        // document.getElementById("current-time").innerHTML = now.getHours() + ":"
        //     + now.getMinutes() + ":" + now.getSeconds();
        document.getElementById("current-time").innerHTML = timeString(now.getHours(), now.getMinutes(), now.getSeconds());
        refreshExpiredRows();

    }

    var input = document.getElementById('file-selector');
    input.onchange = e => {
        var file = e.target.files[0];
        // setting up the reader
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');

        // here we tell the reader what to do when it's done reading...
        reader.onload = readerEvent => {
            var content = readerEvent.target.result.toString(); // this is the content!
            var jsonContent = JSON.parse(content);
            countDownEvents = jsonContent;
            updateTables(countDownEvents);
            localStorage.events = JSON.stringify(countDownEvents);
        }

    }

    // Otherwise, selectors are also supported
    const nextStopJobfp = flatpickr("#next-stop-job-flattimepicker", {
        altInput: true,
        noCalendar: true,
        enableTime: true,
        time_24hr: true,
        enableSeconds  : true,
        inline: true,  // set to true to have the calendar inline
        minuteIncrement: 1,
        altFormat: "H:i:S",
        dateFormat: "H:i:S",
        defaultDate: "18:00:00",
    });

    // Otherwise, selectors are also supported
    const fp = flatpickr("#flattimepicker", {
        altInput: true,
        noCalendar: true,
        enableTime: true,
        time_24hr: true,
        enableSeconds  : true,
        inline: true,  // set to true to have the calendar inline
        minuteIncrement: 1,
        altFormat: "H:i:S",
        dateFormat: "H:i:S",
        defaultDate: "18:00:00",
    });

    var inputs = document.getElementsByClassName("flattimepickerinput");
    for (var i  = 0 ; i < inputs.length ; i++) {
        console.log(inputs[i]);
        inputs[i].style.display = "none";
    }
    //.style.display = "none";


    // Update the count down every 1 second
    var x = setInterval(updateCount, 1000);

    if(typeof(Storage) !== "undefined") {
        console.log("Local storage is supported.");
        // Local storage is available on your browser
        console.log("loaded " + typeof (localStorage.events));
        console.log(localStorage.events);
        if (localStorage.events !== null && localStorage.events !== undefined && localStorage.events.length !== 0) {
            countDownEvents = JSON.parse(localStorage.events);
        }
        if (countDownEvents === undefined || countDownEvents === null) {
            countDownEvents = [];
        }
        updateCount();
        updateTables(countDownEvents);
        console.log("loaded " + typeof (countDownEvents));
        console.log(JSON.stringify(countDownEvents));
    } else {
        console.log("Local storage is not supported.");
        // The condition isn't met, meaning local storage isn't supported
    }
</script>
<style>
    .flatpickr-calendar {
        margin: 10px;
    }
</style>
</body>
</html>
