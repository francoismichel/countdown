<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="svg/bootstrap-icons/bootstrap-icons.css">
    <title>Boutsen Ginion countdown</title>
</head>
<body>
<h1>Countdown</h1>

<!--<div class="container" id="timer"></div>-->
<!-- Optional JavaScript; choose one of the two! -->
<div class="container" style="width: 100%">

    <label for="timepicker">Add new event :</label>

    <input type="time" id="timepicker" name="timepicker"
           min="00:00:00" max="23:59:59" step="1" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" required>
    <input type="text" id="event-name" name="event-name" placeholder="Event name">
    <button class="btn btn-sm btn-success" onclick="addDeadline()"><i class="bi bi-check2"></i></button>
    <span style="width: 100%"><button class="float-right btn btn-sm btn-danger" onclick="resetEvents()"><i class="bi bi-trash"></i> Remove all events </button></span>
    <span style="width: 100%"><button class="float-right btn btn-sm btn-warning" onclick="document.getElementById('file-selector').click();"><i class="bi bi-upload"></i> Load events </button></span>
    <span style="width: 100%"><button class="float-right btn btn-sm btn-primary" onclick="saveFile()"><i class="bi bi-save"></i> Save events </button></span>
    <input type="file" id="file-selector" hidden>
    <a id="save-file" href=""></a>

    <div id="timer-container" class="container border rounded-3">
        <div class="text-center display-1 font-weight-bold"> <strong id="event-to-expire">-</strong> </div>
        <div class="text-center display-7 font-weight-bold"> Expires in </div>
        <div class="text-center display-1 font-weight-bold" style="font-size: 6rem"> <strong id="timer">00:00:00</strong> </div>
        <div class="text-center display-6 font-weight-bold"> <p id="current-time">00:00:00</p> </div>
    </div>

    <table class="table" id="countdown-table">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col" data-name="time">Time</th>
            <th scope="col" data-name="event">Event</th>
            <th scope="col" data-name="action">Action</th>
        </tr>
        </thead>
        <tbody id="countdown-table-body">
        </tbody>
    </table>
</div>
<!-- Option 1: Bootstrap Bundle with Popper -->

<!-- Option 2: Separate Popper and Bootstrap JS -->
<!--
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>
-->
<script>

    function timeToDate(obj) {
        return new Date(0, 0, 0, obj.hours, obj.minutes, obj.seconds);
    }

    function dateToTime(date) {
        return {
            hours: date.getHours(),
            minutes: date.getMinutes(),
            seconds: date.getSeconds(),
        }
    }


    var countDownEvents = [
        // {
        //     hours: 22, minutes: 43, seconds: 5,
        // },
    ];

    function saveFile() {
        var jsonFile = JSON.stringify(countDownEvents);
        var saveFile = document.getElementById('save-file');
        saveFile.setAttribute('href',
            'data:text/plain;charset=utf-8, '
            + encodeURIComponent(jsonFile));
        saveFile.setAttribute('download', "countdown.json");
        saveFile.click();
    }


    function compareTimes(a, b) {
        var timeA = a.hours*3600 + a.minutes*60 + a.seconds;
        var timeB = b.hours*3600 + b.minutes*60 + b.seconds;
        if (timeA < timeB) {
            return -1;
        }
        if (timeA === timeB) {
            return 0;
        }
        return 1;
    }

    function timeExpired(time) {
        return compareTimes(time, dateToTime(new Date())) < 0;
    }

    // Set the date we're counting down to
    // var countDownDate = new Date("Jan 5, 2022 15:37:25").getTime();


    function loadTableData(items) {
        items.sort(compareTimes);
        const table = document.getElementById("countdown-table");
        const tbody = document.getElementById("countdown-table-body");
        tbody.innerHTML = "";
        items.forEach( (item, index) => {
            var row = tbody.insertRow();
            row.setAttribute("data-row-idx", index);
            var idx = row.insertCell(0);
            idx.innerHTML = index+1;
            var date = row.insertCell(1);
            // date.innerHTML = item.hours + ":" + item.minutes + ":" + item.seconds;
            date.innerHTML = timeString(item.hours, item.minutes, item.seconds);
            var name = row.insertCell(2);
            name.innerHTML = item.name;
            var action = row.insertCell(3);
            action.innerHTML = "<button class=\"btn btn-sm btn-danger\" onclick=\"removeDeadline("+index+")\"><i class=\"bi bi-trash\"></i></button>";
            if (timeExpired(item)) {
                date.innerHTML += " (expired)";
                row.className = "bg-light";
            }
        });
    }

    function refreshExpiredRows() {
        const table = document.getElementById("countdown-table");

        for (var i = 0; i < table.rows.length; i++) {
            //iterate through rows
            var row = table.rows[i];
            if (row.getAttribute("data-row-idx") !== undefined && row.getAttribute("data-row-idx") !== null) {
                var idx = Number(row.getAttribute("data-row-idx"));
                var item = countDownEvents[idx];
                var date = row.cells[1];
                date.innerHTML = timeString(item.hours, item.minutes, item.seconds);
                if (timeExpired(item)) {
                    date.innerHTML += " (expired)";
                    row.className = "bg-light";
                }
            }
        }
    }

    function resetEvents() {
        countDownEvents = []
        localStorage.events = JSON.stringify(countDownEvents);
        loadTableData(countDownEvents);
    }

    function removeDeadline(index) {
        countDownEvents.splice(index, 1);
        loadTableData(countDownEvents);
        // localStorage.setItem("events", JSON.stringify(countDownEvents));
        localStorage.events = JSON.stringify(countDownEvents);
    }


    function addDeadline() {
        var input = document.getElementById("timepicker");

        var splitted = input.value.split(":");

        var eventName = document.getElementById("event-name").value;
        var event = {name:eventName, hours: Number(splitted[0]), minutes: Number(splitted[1]), seconds: Number(splitted[2])};

        if (Number.isNaN(event.hours)) {
            event.hours = 0;
        }
        if (Number.isNaN(event.minutes)) {
            event.minutes = 0;
        }
        if (Number.isNaN(event.hours)) {
            event.seconds = 0;
        }

        countDownEvents.push(event);
        loadTableData(countDownEvents);
        // localStorage.setItem("events", JSON.stringify(countDownEvents));
        localStorage.events = JSON.stringify(countDownEvents);
    }

    function timeString(hours, minutes, seconds) {
        var hoursStr = "" + hours;
        if (hoursStr.length === 1) {
            hoursStr = "0" + hoursStr;
        }
        var minutesStr = "" + minutes;
        if (minutesStr.length === 1) {
            minutesStr = "0" + minutesStr;
        }
        var secondsStr = "" + seconds;
        if (secondsStr.length === 1) {
            secondsStr = "0" + secondsStr;
        }
        return hoursStr + ":" + minutesStr + ":" + secondsStr;
    }

    function updateCount() {
        countDownEvents.sort(compareTimes);
        var now = new Date();
        var countDownIndex = 0;


        while (countDownIndex < countDownEvents.length) {
            if (compareTimes(countDownEvents[countDownIndex], dateToTime(now)) >= 0) {
                break;
            } else {
                // expired, pop it ?
                // countDownEvents.pop();
            }
            countDownIndex++;
        }
        if (countDownIndex < countDownEvents.length) {
            var countDownDate = new Date();
            countDownDate.setHours(countDownEvents[countDownIndex].hours);
            countDownDate.setMinutes(countDownEvents[countDownIndex].minutes);
            countDownDate.setSeconds(countDownEvents[countDownIndex].seconds);
            var countDownDateNumber = countDownDate.getTime();
            // Get today's date and time

            // Find the distance between now and the count down date
            var distance = countDownDateNumber - now;

            // Time calculations for days, hours, minutes and seconds
            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result in the element with id="timer"
            // document.getElementById("timer").innerHTML = days + "d " + hours + "h "
            //     + minutes + "m " + seconds + "s ";
            // document.getElementById("timer").innerHTML = hours + ":"
            //     + minutes + ":" + seconds;
            document.getElementById("timer").innerHTML = timeString(hours, minutes, seconds);
            document.getElementById("event-to-expire").innerHTML = countDownEvents[countDownIndex].name;
            if (days === 0 && hours === 0 && minutes === 0 && seconds < 30) {
                document.getElementById("timer-container").classList.add("bg-danger")
            } else {
                document.getElementById("timer-container").classList.remove("bg-danger")
            }
            // If the count down is finished, write some text
        } else if (countDownEvents.length > 0) {
            document.getElementById("timer").innerHTML = "EXPIRED";
        } else {
            document.getElementById("timer").innerHTML = "00:00:00";
        }
        // document.getElementById("current-time").innerHTML = now.getHours() + ":"
        //     + now.getMinutes() + ":" + now.getSeconds();
        document.getElementById("current-time").innerHTML = timeString(now.getHours(), now.getMinutes(), now.getSeconds());
        refreshExpiredRows();

    }

    var input = document.getElementById('file-selector');
    input.onchange = e => {
        var file = e.target.files[0];
        // setting up the reader
        var reader = new FileReader();
        reader.readAsText(file,'UTF-8');

        // here we tell the reader what to do when it's done reading...
        reader.onload = readerEvent => {
            var content = readerEvent.target.result.toString(); // this is the content!
            var jsonContent = JSON.parse(content);
            countDownEvents = jsonContent;
            loadTableData(countDownEvents);
            localStorage.events = JSON.stringify(countDownEvents);
        }

    }


    // Update the count down every 1 second
    var x = setInterval(updateCount, 1000);

    if(typeof(Storage) !== "undefined") {
        console.log("Local storage is supported.");
        // Local storage is available on your browser
        console.log("loaded " + typeof (localStorage.events));
        console.log(localStorage.events);
        countDownEvents = JSON.parse(localStorage.events);
        if (countDownEvents === undefined || countDownEvents === null) {
            countDownEvents = [];
        }
        updateCount();
        loadTableData(countDownEvents);
        console.log("loaded " + typeof (countDownEvents));
        console.log(JSON.stringify(countDownEvents));
    } else {
        console.log("Local storage is not supported.");
        // The condition isn't met, meaning local storage isn't supported
    }
</script>
</body>
</html>